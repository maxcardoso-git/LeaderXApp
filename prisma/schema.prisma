generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// APPROVALS
// ============================================

model Approval {
  id              String    @id @default(uuid())
  type            String
  state           String    @default("PENDING")
  candidateId     String    @map("candidate_id")
  candidateName   String?   @map("candidate_name")
  priority        String    @default("MEDIUM")
  tenantId        String    @map("tenant_id")
  orgId           String    @map("org_id")
  cycleId         String?   @map("cycle_id")
  metadata        Json?
  decidedAt       DateTime? @map("decided_at")
  decidedBy       String?   @map("decided_by")
  decisionReason  String?   @map("decision_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  @@index([tenantId, orgId])
  @@index([tenantId, state])
  @@index([tenantId, candidateId])
  @@index([tenantId, cycleId])
  @@index([createdAt])
  @@map("approvals")
}

// ============================================
// CANDIDATES (for Points calculation)
// ============================================

model Candidate {
  id          String   @id @default(uuid())
  name        String
  email       String?
  tenantId    String   @map("tenant_id")
  orgId       String   @map("org_id")
  score       Float    @default(0)
  rank        Int?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, email])
  @@index([tenantId, orgId])
  @@index([tenantId, score])
  @@map("candidates")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id            String   @id @default(uuid())
  action        String
  resourceType  String   @map("resource_type")
  resourceId    String   @map("resource_id")
  actorId       String   @map("actor_id")
  tenantId      String   @map("tenant_id")
  orgId         String   @map("org_id")
  correlationId String?  @map("correlation_id")
  metadata      Json?
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([tenantId, resourceType, resourceId])
  @@index([tenantId, actorId])
  @@index([tenantId, timestamp])
  @@index([correlationId])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String   @id @default(uuid())
  recipientId String   @map("recipient_id")
  channel     String   @default("PUSH")
  templateId  String?  @map("template_id")
  subject     String?
  message     String
  status      String   @default("PENDING")
  tenantId    String   @map("tenant_id")
  orgId       String   @map("org_id")
  metadata    Json?
  sentAt      DateTime? @map("sent_at")
  failedAt    DateTime? @map("failed_at")
  errorMessage String?  @map("error_message")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId, recipientId])
  @@index([tenantId, status])
  @@map("notifications")
}

// ============================================
// NOTIFICATION TEMPLATES
// ============================================

model NotificationTemplate {
  id        String   @id @default(uuid())
  name      String
  channel   String
  subject   String?
  body      String
  variables String[]
  tenantId  String   @map("tenant_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@map("notification_templates")
}

// ============================================
// POINTS DOMAIN - Ledger/Account System
// ============================================

/// Conta de pontos por tenant + owner (USER ou ORG)
model PointAccount {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  ownerType String   @map("owner_type") // USER | ORG
  ownerId   String   @map("owner_id")
  status    String   @default("ACTIVE") // ACTIVE | SUSPENDED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ledgerEntries PointLedgerEntry[]
  holds         PointHold[]

  @@unique([tenantId, ownerType, ownerId])
  @@index([tenantId])
  @@index([ownerId])
  @@map("point_accounts")
}

/// Ledger append-only. Cada linha representa um movimento de pontos.
model PointLedgerEntry {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  accountId      String   @map("account_id")
  entryType      String   @map("entry_type") // CREDIT | DEBIT | HOLD | RELEASE | COMMIT | REVERSAL
  amount         Int      // sempre > 0
  reasonCode     String   @map("reason_code")
  referenceType  String   @map("reference_type") // RESERVATION | PURCHASE | APPROVAL | ADJUSTMENT | REFUND | SYSTEM
  referenceId    String   @map("reference_id")
  idempotencyKey String?  @map("idempotency_key")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  account PointAccount @relation(fields: [accountId], references: [id])

  @@index([tenantId, accountId, createdAt])
  @@index([tenantId, referenceType, referenceId])
  @@index([idempotencyKey])
  @@map("point_ledger_entries")
}

/// Estado de holds (reservas) de pontos por referência
model PointHold {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  accountId     String    @map("account_id")
  referenceType String    @map("reference_type")
  referenceId   String    @map("reference_id")
  amount        Int
  status        String    @default("ACTIVE") // ACTIVE | COMMITTED | RELEASED | EXPIRED
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  account PointAccount @relation(fields: [accountId], references: [id])

  @@unique([tenantId, accountId, referenceType, referenceId])
  @@index([tenantId])
  @@index([accountId])
  @@index([status])
  @@map("point_holds")
}

// ============================================
// IDEMPOTENCY (Cross-domain)
// ============================================

/// Tabela reutilizável para idempotência de comandos
model IdempotencyRecord {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  scope           String    // ex: POINTS:HoldPoints, POINTS:CreditPoints
  idemKey         String    @map("idem_key") // Idempotency-Key recebido
  requestHash     String    @map("request_hash") // hash do payload
  status          String    @default("IN_PROGRESS") // IN_PROGRESS | COMPLETED | FAILED
  httpStatus      Int?      @map("http_status")
  responsePayload Json?     @map("response_payload")
  errorPayload    Json?     @map("error_payload")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  expiresAt       DateTime  @map("expires_at")

  @@unique([tenantId, scope, idemKey])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("idempotency_records")
}

// ============================================
// OUTBOX (Cross-domain event publishing)
// ============================================

/// Outbox pattern para publicação de eventos após commit
model OutboxEvent {
  id            String    @id @default(uuid())
  tenantId      String?   @map("tenant_id")
  aggregateType String    @map("aggregate_type") // POINTS | APPROVALS | etc
  aggregateId   String    @map("aggregate_id")
  eventType     String    @map("event_type") // PointsHeld | PointsCredited | etc
  correlationId String?   @map("correlation_id")
  payload       Json
  metadata      Json?
  status        String    @default("PENDING") // PENDING | PROCESSING | PUBLISHED | DEAD
  retryCount    Int       @default(0) @map("retry_count")
  maxRetries    Int       @default(3) @map("max_retries")
  lastError     String?   @map("last_error")
  processedAt   DateTime? @map("processed_at")
  scheduledAt   DateTime  @default(now()) @map("scheduled_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([status, scheduledAt])
  @@index([tenantId, aggregateType, aggregateId])
  @@map("outbox_events")
}

// ============================================
// RESERVATIONS DOMAIN
// ============================================

/// Reservation policy: rules for reservations by resource type
model ReservationPolicy {
  id               String    @id @default(uuid())
  tenantId         String    @map("tenant_id")
  eventId          String    @map("event_id")
  resourceType     String    @map("resource_type") // TABLE | SEAT | SLOT
  costInPoints     Int       @default(0) @map("cost_in_points")
  maxPerUser       Int       @default(1) @map("max_per_user")
  requiresApproval Boolean   @default(false) @map("requires_approval")
  holdTtlSeconds   Int       @default(900) @map("hold_ttl_seconds")
  windowStart      DateTime? @map("window_start")
  windowEnd        DateTime? @map("window_end")
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  reservations Reservation[]

  @@index([tenantId, eventId, resourceType, isActive])
  @@index([eventId])
  @@map("reservation_policies")
}

/// Reservable resource (table, seat, slot) with capacity
model ReservableResource {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  eventId       String   @map("event_id")
  resourceType  String   @map("resource_type") // TABLE | SEAT | SLOT
  name          String
  capacityTotal Int      @default(1) @map("capacity_total")
  metadata      Json?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  reservations Reservation[]

  @@index([tenantId, eventId, resourceType])
  @@index([tenantId, eventId, isActive])
  @@map("reservable_resources")
}

/// Reservation aggregate root - lifecycle HOLD -> CONFIRMED or HOLD -> RELEASED/EXPIRED
model Reservation {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  eventId      String    @map("event_id")
  resourceId   String    @map("resource_id")
  resourceType String    @map("resource_type") // TABLE | SEAT | SLOT
  policyId     String    @map("policy_id")
  ownerId      String    @map("owner_id")
  ownerType    String    @map("owner_type") // MEMBER | LEADER | GUEST
  status       String    @default("HOLD") // HOLD | CONFIRMED | RELEASED | EXPIRED | CANCELLED
  pointsHoldId String?   @map("points_hold_id")
  expiresAt    DateTime? @map("expires_at")
  confirmedAt  DateTime? @map("confirmed_at")
  releasedAt   DateTime? @map("released_at")
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  resource ReservableResource @relation(fields: [resourceId], references: [id])
  policy   ReservationPolicy  @relation(fields: [policyId], references: [id])

  @@index([tenantId, eventId, ownerId, status])
  @@index([tenantId, resourceId, status])
  @@index([tenantId, eventId, resourceId, status])
  @@index([status, expiresAt])
  @@map("reservations")
}

// ============================================
// IDENTITY & ACCESS DOMAIN
// ============================================

/// Identity user - represents a user in the platform
model IdentityUser {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  externalId String?   @map("external_id")
  email      String?
  fullName   String?   @map("full_name")
  status     String    @default("ACTIVE") // ACTIVE | INACTIVE | SUSPENDED
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  assignments AccessAssignment[]
  sessions    UserSession[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, externalId])
  @@index([tenantId, status])
  @@map("identity_users")
}

/// Permission - atomic permissions (e.g., EVENTS.CREATE, POINTS.CREDIT)
model Permission {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, category])
  @@map("permissions")
}

/// Role - functional roles that group permissions
model Role {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  effect      String   @default("ALLOW") // ALLOW | DENY
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]
  assignments     AccessAssignment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("roles")
}

/// RolePermission - association between Role and Permission with effect
model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")
  effect       String @default("ALLOW") // ALLOW | DENY

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

/// AccessAssignment - assigns a Role to a User with scope
model AccessAssignment {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  roleId     String    @map("role_id")
  scopeType  String    @map("scope_type") // GLOBAL | TENANT | EVENT | COMMUNITY | TABLE | NETWORK_NODE | RESOURCE
  scopeId    String?   @map("scope_id")
  status     String    @default("ACTIVE") // ACTIVE | REVOKED
  assignedBy String?   @map("assigned_by")
  assignedAt DateTime  @default(now()) @map("assigned_at")
  revokedAt  DateTime? @map("revoked_at")
  metadata   Json?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  user IdentityUser @relation(fields: [userId], references: [id])
  role Role         @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId, roleId, scopeType, scopeId, status])
  @@index([tenantId, userId, status])
  @@index([tenantId, roleId, status])
  @@index([tenantId, scopeType, scopeId])
  @@map("access_assignments")
}

/// UserSession - tracks active user login sessions
model UserSession {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  userId        String    @map("user_id")
  deviceType    String?   @map("device_type") // DESKTOP | MOBILE | TABLET | OTHER
  deviceName    String?   @map("device_name")
  browser       String?
  browserVersion String?  @map("browser_version")
  os            String?
  osVersion     String?   @map("os_version")
  ipAddress     String?   @map("ip_address")
  location      String?   // City, Country
  userAgent     String?   @map("user_agent")
  lastActivity  DateTime  @default(now()) @map("last_activity")
  expiresAt     DateTime? @map("expires_at")
  status        String    @default("ACTIVE") // ACTIVE | EXPIRED | REVOKED
  revokedAt     DateTime? @map("revoked_at")
  revokedReason String?   @map("revoked_reason")
  metadata      Json?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  user IdentityUser @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([tenantId, userId, status])
  @@index([lastActivity])
  @@map("user_sessions")
}

// ============================================
// EVENTS DOMAIN
// ============================================

/// Event - represents an event with lifecycle management
model Event {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  name            String
  description     String?
  status          String    @default("DRAFT") // DRAFT | PUBLISHED | ACTIVE | CLOSED | CANCELED
  visibility      String    @default("PUBLIC") // PUBLIC | PRIVATE | INVITE_ONLY
  reservationMode String    @default("FREE") @map("reservation_mode") // POINTS | FREE | APPROVAL
  startsAt        DateTime  @map("starts_at")
  endsAt          DateTime  @map("ends_at")
  metadata        Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  phases         EventPhase[]
  tables         EventTable[]
  policyBindings EventPolicyBinding[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, visibility, status])
  @@index([tenantId, startsAt, endsAt])
  @@map("events")
}

/// EventPhase - represents a logical phase of an event
model EventPhase {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  eventId   String   @map("event_id")
  name      String
  startsAt  DateTime @map("starts_at")
  endsAt    DateTime @map("ends_at")
  sortOrder Int      @default(0) @map("sort_order")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([tenantId, eventId])
  @@map("event_phases")
}

/// EventTable - represents a table within an event
model EventTable {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  eventId   String   @map("event_id")
  name      String
  capacity  Int      @default(1)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  seats EventSeat[]

  @@index([tenantId, eventId])
  @@map("event_tables")
}

/// EventSeat - represents a seat inside a table
model EventSeat {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  eventId    String   @map("event_id")
  tableId    String   @map("table_id")
  seatNumber Int      @map("seat_number")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  table EventTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, seatNumber])
  @@index([tenantId, eventId])
  @@index([tenantId, tableId])
  @@map("event_seats")
}

/// EventPolicyBinding - associates governance or reservation policies to the event
model EventPolicyBinding {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  eventId    String   @map("event_id")
  policyCode String   @map("policy_code")
  scope      String   @default("EVENT") // GLOBAL | TENANT | EVENT
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([tenantId, eventId, policyCode])
  @@index([tenantId, eventId])
  @@map("event_policy_bindings")
}

// ============================================
// GOVERNANCE DOMAIN
// ============================================

/// GovernancePolicy - represents a governance policy with rules and scope
model GovernancePolicy {
  id          String   @id @default(uuid())
  tenantId    String?  @map("tenant_id")
  code        String   @unique
  name        String
  description String?
  status      String   @default("ACTIVE") // ACTIVE | DEPRECATED
  scope       String   @default("GLOBAL") // GLOBAL | TENANT
  rules       Json     // PolicyRules: { conditions: [], effect: 'ALLOW' | 'DENY' }
  version     Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@index([scope])
  @@map("governance_policies")
}

/// GovernanceAuditLog - immutable audit record of governance evaluations
model GovernanceAuditLog {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  policyCode  String   @map("policy_code")
  policyId    String?  @map("policy_id")
  decision    String   // ALLOW | DENY
  context     Json     // PolicyEvaluationContext
  reason      String?
  evaluatedAt DateTime @default(now()) @map("evaluated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([tenantId, policyCode])
  @@index([tenantId, decision])
  @@index([evaluatedAt])
  @@map("governance_audit_logs")
}

// ============================================
// AUDIT & COMPLIANCE DOMAIN
// ============================================

/// ComplianceCheck - rule definition for compliance validation
model ComplianceCheck {
  id          String   @id @default(uuid())
  tenantId    String?  @map("tenant_id")
  code        String   @unique
  name        String
  description String?
  severity    String   @default("MEDIUM") // LOW | MEDIUM | HIGH | CRITICAL
  rules       Json     // ComplianceRules: { type: 'RULE_SET', rules: [] }
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  results ComplianceCheckResult[]

  @@index([tenantId])
  @@index([enabled])
  @@index([severity])
  @@map("compliance_checks")
}

/// ComplianceCheckResult - result of a single compliance check execution
model ComplianceCheckResult {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  checkId    String   @map("check_id")
  checkCode  String   @map("check_code")
  reportId   String?  @map("report_id")
  status     String   // PASS | FAIL | WARNING
  evidence   Json?    // array of evidence items
  executedAt DateTime @default(now()) @map("executed_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  check  ComplianceCheck   @relation(fields: [checkId], references: [id])
  report ComplianceReport? @relation(fields: [reportId], references: [id])

  @@index([tenantId])
  @@index([tenantId, checkCode])
  @@index([tenantId, reportId])
  @@index([tenantId, status])
  @@index([executedAt])
  @@map("compliance_check_results")
}

/// ComplianceReport - snapshot of compliance execution results
model ComplianceReport {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  summary     Json     // ComplianceSummary: { totalChecks, passed, failed, warnings }
  generatedAt DateTime @default(now()) @map("generated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  results ComplianceCheckResult[]

  @@index([tenantId])
  @@index([generatedAt])
  @@map("compliance_reports")
}

// ============================================
// NETWORK DOMAIN
// ============================================

/// NetworkNode - represents a node (member or entity) in the network hierarchy
model NetworkNode {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  ownerId        String   @map("owner_id")
  ownerType      String   @map("owner_type") // TENANT | COMMUNITY | EVENT | TABLE | NETWORK
  userId         String?  @map("user_id")
  role           String   @default("MEMBER") // OWNER | ADMIN | EMBAIXADOR | MEMBER | GUEST
  status         String   @default("ACTIVE") // ACTIVE | INACTIVE | SUSPENDED
  hierarchyLevel Int      @default(0) @map("hierarchy_level")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  parentRelations NetworkRelation[] @relation("ChildNode")
  childRelations  NetworkRelation[] @relation("ParentNode")

  @@unique([tenantId, ownerId, ownerType, userId])
  @@index([tenantId])
  @@index([tenantId, ownerId, ownerType])
  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([tenantId, role])
  @@map("network_nodes")
}

/// NetworkRelation - represents parent-child relationships between nodes
model NetworkRelation {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  parentNodeId String   @map("parent_node_id")
  childNodeId  String   @map("child_node_id")
  relationType String   @default("DIRECT") @map("relation_type") // DIRECT | INVITED | DELEGATED
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  parentNode NetworkNode @relation("ParentNode", fields: [parentNodeId], references: [id], onDelete: Cascade)
  childNode  NetworkNode @relation("ChildNode", fields: [childNodeId], references: [id], onDelete: Cascade)

  @@unique([parentNodeId, childNodeId])
  @@index([tenantId])
  @@index([tenantId, parentNodeId])
  @@index([tenantId, childNodeId])
  @@map("network_relations")
}

/// StructureType - defines types of organizational structures
model StructureType {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  code             String   // COMMUNITY | EVENT | TABLE | NETWORK | TEAM | DEPARTMENT
  name             String
  description      String?
  icon             String?
  color            String?
  scope            String?  // GLOBAL_ALL_COUNTRIES | COUNTRY_GROUP | CITY_GROUP | SINGLE_CITY
  hierarchyLevel   Int?     @map("hierarchy_level")
  leadershipRoleId String?  @map("leadership_role_id")
  maxLeaders       Int      @default(1) @map("max_leaders")
  maxLevels        Int      @default(5) @map("max_levels")
  allowNested      Boolean  @default(true) @map("allow_nested")
  metadata         Json?
  status           String   @default("ACTIVE") // ACTIVE | INACTIVE
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  structures     Structure[]
  leadershipRole Position?   @relation(fields: [leadershipRoleId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("structure_types")
}

/// Structure - represents an organizational unit (community, event, table, etc.)
model Structure {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  typeId          String   @map("type_id")
  parentId        String?  @map("parent_id")
  code            String
  name            String
  description     String?
  status          String   @default("ACTIVE") // ACTIVE | INACTIVE | ARCHIVED
  level           Int      @default(0)
  path            String?  // Materialized path for hierarchy (e.g., "/root/parent/child")
  metadata        Json?
  settings        Json?    // Structure-specific settings
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  type            StructureType     @relation(fields: [typeId], references: [id])
  parent          Structure?        @relation("StructureHierarchy", fields: [parentId], references: [id])
  children        Structure[]       @relation("StructureHierarchy")
  leaders         StructureLeader[]
  approvalChain   ApprovalChainStep[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, typeId])
  @@index([tenantId, parentId])
  @@index([tenantId, status])
  @@index([path])
  @@map("structures")
}

/// StructureLeader - assigns leadership roles to users within structures
model StructureLeader {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  structureId String    @map("structure_id")
  userId      String    @map("user_id")
  role        String    // OWNER | COORDINATOR | LEADER | DELEGATE
  isPrimary   Boolean   @default(false) @map("is_primary")
  canApprove  Boolean   @default(true) @map("can_approve")
  maxAmount   Decimal?  @map("max_amount") @db.Decimal(15, 2) // Approval limit
  startDate   DateTime  @default(now()) @map("start_date")
  endDate     DateTime? @map("end_date")
  status      String    @default("ACTIVE") // ACTIVE | INACTIVE | EXPIRED
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  structure Structure @relation(fields: [structureId], references: [id], onDelete: Cascade)

  @@unique([tenantId, structureId, userId, role])
  @@index([tenantId])
  @@index([tenantId, structureId])
  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@map("structure_leaders")
}

/// ApprovalChainStep - defines approval chain steps for a structure
model ApprovalChainStep {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  structureId String   @map("structure_id")
  stepOrder   Int      @map("step_order")
  roleRequired String  @map("role_required") // Role required to approve at this step
  minApprovers Int     @default(1) @map("min_approvers")
  maxAmount   Decimal? @map("max_amount") @db.Decimal(15, 2) // Amount threshold for this step
  isOptional  Boolean  @default(false) @map("is_optional")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  structure Structure @relation(fields: [structureId], references: [id], onDelete: Cascade)

  @@unique([tenantId, structureId, stepOrder])
  @@index([tenantId])
  @@index([tenantId, structureId])
  @@map("approval_chain_steps")
}

// ============================================
// SETTINGS DOMAIN
// ============================================

/// TenantSettings - stores tenant-specific settings like themes
model TenantSettings {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  key       String
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("tenant_settings")
}

/// RegistrationBlockPoints - points configuration for registration profile blocks
model RegistrationBlockPoints {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  blockKey     String   @map("block_key") // address, dietary_restrictions, personal_data, etc.
  blockName    String   @map("block_name")
  points       Int      @default(0)
  active       Boolean  @default(true)
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, blockKey])
  @@index([tenantId])
  @@index([tenantId, active])
  @@map("registration_block_points")
}

/// RegistrationBonusSettings - bonus points for completing all registration blocks
model RegistrationBonusSettings {
  id           String   @id @default(uuid())
  tenantId     String   @unique @map("tenant_id")
  bonusPoints  Int      @default(500) @map("bonus_points")
  targetTotal  Int      @default(500) @map("target_total") // Meta total de pontos dos blocos
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("registration_bonus_settings")
}

// ============================================
// TAXONOMY DOMAIN
// ============================================

/// Category - product/service categories for taxonomy
model Category {
  id                 String   @id @default(uuid())
  tenantId           String   @map("tenant_id")
  code               String
  name               String
  description        String?
  parentId           String?  @map("parent_id")
  previousCategoryId String?  @map("previous_category_id") // Classification ID required for progression
  level              Int      @default(0)
  path               String?
  icon               String?
  color              String?
  sortOrder          Int      @default(0) @map("sort_order")
  status             String   @default("ACTIVE")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, parentId])
  @@index([tenantId, status])
  @@map("categories")
}

/// Segment - market/business segments
model Segment {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  icon        String?
  color       String?
  sortOrder   Int      @default(0) @map("sort_order")
  status      String   @default("ACTIVE")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("segments")
}

/// Line - product/service lines with strategic event classification
model Line {
  id                 String   @id @default(uuid())
  tenantId           String   @map("tenant_id")
  code               String
  name               String
  description        String?
  segmentId          String?  @map("segment_id")
  icon               String?
  color              String?
  sortOrder          Int      @default(0) @map("sort_order")
  status             String   @default("ACTIVE")
  // Strategic Event Classification
  purposeId          String?  @map("purpose_id") // Single selection: NETWORKING, CONTENT, RELATIONSHIP, etc.
  targetAudiences    String[] @default([]) @map("target_audiences") // Multi-selection: C_LEVEL, FOUNDERS, etc.
  seniorityLevel     String?  @map("seniority_level") // Single selection: EXPLORATORY, INTERMEDIATE, etc.
  interactionFormats String[] @default([]) @map("interaction_formats") // Multi-selection: TABLES, PANELS, etc.
  relationshipDepth  Int?     @map("relationship_depth") // 1-5 scale
  strategicTags      String[] @default([]) @map("strategic_tags") // Free-form tags
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, segmentId])
  @@index([tenantId, status])
  @@index([tenantId, purposeId])
  @@map("lines")
}

/// Classification - classifications within categories
model Classification {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  categoryId   String   @map("category_id")
  name         String
  description  String?
  badgeColor   String   @default("#c4a45a") @map("badge_color")
  displayOrder Int      @default(0) @map("display_order")
  status       String   @default("ACTIVE")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, categoryId, name])
  @@index([tenantId])
  @@index([tenantId, categoryId])
  @@index([tenantId, status])
  @@map("classifications")
}

/// Program - organizational programs (Plans)
model Program {
  id                   String   @id @default(uuid())
  tenantId             String   @map("tenant_id")
  code                 String
  name                 String
  description          String?
  categoryId           String?  @map("category_id")
  renewalPeriodMonths  Int?     @map("renewal_period_months") // 12, 24, 36 months
  billingPeriod        String?  @map("billing_period") // MONTHLY, QUARTERLY, SEMIANNUAL, ANNUAL
  isActive             Boolean  @default(true) @map("is_active")
  metadata             Json?
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  pricing      PlanPricing?
  priceTables  ProgramPriceTable[]
  benefits     PlanBenefit[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, categoryId])
  @@index([tenantId, isActive])
  @@map("programs")
}

/// PlanPricing - pricing information for programs/plans (legacy, kept for backwards compatibility)
model PlanPricing {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  programId      String   @unique @map("program_id")
  monthlyValue   Decimal  @map("monthly_value") @db.Decimal(10, 2)
  currency       String   @default("BRL")
  validity       String?  // e.g., "12 months", "Annual", "Monthly"
  pointsPerMonth Int      @default(0) @map("points_per_month")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([programId])
  @@map("plan_pricing")
}

/// ProgramPriceTable - price tables with validity periods for programs
model ProgramPriceTable {
  id             String    @id @default(uuid())
  tenantId       String    @map("tenant_id")
  programId      String    @map("program_id")
  name           String?   // Optional name for the price table (e.g., "Promo 2024")
  monthlyValue   Decimal   @map("monthly_value") @db.Decimal(10, 2)
  currency       String    @default("BRL")
  pointsPerMonth Int       @default(0) @map("points_per_month")
  startsAt       DateTime  @map("starts_at")
  endsAt         DateTime? @map("ends_at") // null means ongoing/no end date
  isActive       Boolean   @default(true) @map("is_active")
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([programId])
  @@index([tenantId, programId, isActive])
  @@index([tenantId, startsAt, endsAt])
  @@map("program_price_tables")
}

/// SubscriberBenefit - benefits that can be assigned to plans
model SubscriberBenefit {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  type        String   // EXCLUSIVE | DISCOUNT | ACCESS | POINTS | OTHER
  icon        String?
  isActive    Boolean  @default(true) @map("is_active")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  planBenefits      PlanBenefit[]
  avatarBenefitConfigs AvatarBenefitConfig[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, isActive])
  @@map("subscriber_benefits")
}

/// PlanBenefit - junction table linking plans to benefits
model PlanBenefit {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  programId  String   @map("program_id")
  benefitId  String   @map("benefit_id")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  program Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  benefit SubscriberBenefit @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([programId, benefitId])
  @@index([tenantId])
  @@index([programId])
  @@index([benefitId])
  @@map("plan_benefits")
}

/// Position - organizational positions (cargos)
model Position {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  code           String
  name           String
  description    String?
  hierarchyGroup String   @map("hierarchy_group")
  level          Int      @default(0)
  canApprove     Boolean  @default(false) @map("can_approve")
  approvalLimit  Decimal? @map("approval_limit") @db.Decimal(15, 2)
  icon           String?
  color          String?
  sortOrder      Int      @default(0) @map("sort_order")
  status         String   @default("ACTIVE")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  structureTypes StructureType[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, hierarchyGroup])
  @@index([tenantId, status])
  @@map("positions")
}

/// HierarchyGroup - groups of positions for organization
model HierarchyGroup {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  level       Int      @default(0)
  icon        String?
  color       String?
  sortOrder   Int      @default(0) @map("sort_order")
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("hierarchy_groups")
}

/// Scope - structure scope levels (geographic/organizational)
model Scope {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  level       Int      @default(1)
  sortOrder   Int      @default(0) @map("sort_order")
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, level])
  @@map("scopes")
}

/// Cycle - business/workflow cycles
model Cycle {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  code        String
  name        String
  description String?
  pipelineId  String?   @map("pipeline_id")
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  isCurrent   Boolean   @default(false) @map("is_current")
  status      String    @default("PLANNED")
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  pipeline    PlmPipeline? @relation(fields: [pipelineId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, isCurrent])
  @@index([pipelineId])
  @@map("cycles")
}

/// TableName - templates for event table names
model TableName {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  name            String
  icon            String?
  color           String?
  defaultCapacity Int?     @map("default_capacity")
  displayOrder    Int?     @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, displayOrder])
  @@map("table_names")
}

/// ParticipantAvatar - avatar types for event participants
model ParticipantAvatar {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  code         String
  name         String
  emoji        String
  color        String
  avatarUrl    String?  @map("avatar_url")
  isDefault    Boolean  @default(false) @map("is_default")
  displayOrder Int?     @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  stageAvatarRules PlmStageAvatarRule[]
  benefitConfigs   AvatarBenefitConfig[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, displayOrder])
  @@map("participant_avatars")
}

/// AvatarBenefitConfig - configuration of point costs for avatar x benefit combinations
model AvatarBenefitConfig {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  avatarId   String   @map("avatar_id")
  benefitId  String   @map("benefit_id")
  status     String   @default("FREE") // FREE | POINTS | BLOCKED
  pointCost  Int      @default(0) @map("point_cost")
  isEnabled  Boolean  @default(true) @map("is_enabled")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  avatar  ParticipantAvatar @relation(fields: [avatarId], references: [id], onDelete: Cascade)
  benefit SubscriberBenefit @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([tenantId, avatarId, benefitId])
  @@index([tenantId])
  @@index([tenantId, avatarId])
  @@index([tenantId, benefitId])
  @@map("avatar_benefit_configs")
}

/// Supplier - external suppliers/vendors
model Supplier {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  code          String
  name          String
  tradeName     String?  @map("trade_name")
  document      String?
  documentType  String?  @map("document_type")
  email         String?
  phone         String?
  website       String?
  street        String?
  number        String?
  complement    String?
  neighborhood  String?
  city          String?
  state         String?
  zipCode       String?  @map("zip_code")
  country       String?  @default("BR")
  categoryId    String?  @map("category_id")
  segmentId     String?  @map("segment_id")
  status        String   @default("ACTIVE")
  rating        Int?
  notes         String?
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, categoryId])
  @@index([tenantId, segmentId])
  @@map("suppliers")
}

// ============================================
// GOVERNANCE DOMAIN - Working Units
// ============================================

// ============================================
// EVENT TYPES & VENUES (TAXONOMY)
// ============================================

/// EventType - types of events that can be hosted
model EventType {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  venueEventTypes EventVenueEventType[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("event_types")
}

/// EventVenue - locations where events can be held
model EventVenue {
  id                    String   @id @default(uuid())
  tenantId              String   @map("tenant_id")
  name                  String
  venueType             String   @map("venue_type") // HOTEL | RESORT | CLUB | CORPORATE | RESTAURANT | EVENT_SPACE | OTHER
  address               Json?    // VenueAddress: { zip, street, number, complement, neighborhood, city, state, country }
  parking               Json?    // VenueParking: { type, averageCost, is24Hours, operatingHours }
  areas                 Json?    // VenueArea[]: [{ name, capacity, allowsTables, tableCapacity }]
  techInfrastructure    Json?    @map("tech_infrastructure") // { hasProjector, hasStage, hasAuditorium, hasSoundSystem, hasLighting, otherEquipment }
  serviceInfrastructure Json?    @map("service_infrastructure") // { hasHotel, hasRestaurant, hasCafe, hasBar, hasPool, otherServices }
  technicalTeam         Json?    @map("technical_team") // { hasAudioVisual, hasReception, hasRegistration, hasSecurity, hasCleaning, otherTeams }
  availableMonths       Int[]    @default([]) @map("available_months") // [1,2,3...12]
  isActive              Boolean  @default(true) @map("is_active")
  notes                 String?
  metadata              Json?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  venueEventTypes EventVenueEventType[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, venueType])
  @@index([tenantId, isActive])
  @@map("event_venues")
}

/// EventVenueEventType - junction table for venue allowed event types
model EventVenueEventType {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  venueId     String   @map("venue_id")
  eventTypeId String   @map("event_type_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  venue     EventVenue @relation(fields: [venueId], references: [id], onDelete: Cascade)
  eventType EventType  @relation(fields: [eventTypeId], references: [id], onDelete: Cascade)

  @@unique([venueId, eventTypeId])
  @@index([tenantId])
  @@index([venueId])
  @@index([eventTypeId])
  @@map("event_venue_event_types")
}

// ============================================
// GOVERNANCE DOMAIN - Working Units
// ============================================

/// WorkingUnit - Groups and Nuclei for social organization
model WorkingUnit {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  structureId   String?   @map("structure_id") // Links to Network Structure
  parentId      String?   @map("parent_id")
  code          String
  name          String
  description   String?
  type          String    // GROUP | NUCLEUS | TEAM | COMMITTEE
  level         Int       @default(0)
  path          String?
  maxMembers    Int?      @map("max_members")
  status        String    @default("ACTIVE") // ACTIVE | INACTIVE | ARCHIVED
  metadata      Json?
  settings      Json?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Self-referential relation
  parent        WorkingUnit?  @relation("WorkingUnitHierarchy", fields: [parentId], references: [id])
  children      WorkingUnit[] @relation("WorkingUnitHierarchy")
  memberships   WorkingUnitMembership[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, structureId])
  @@index([tenantId, parentId])
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@map("working_units")
}

/// WorkingUnitMembership - Members of working units
model WorkingUnitMembership {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  workingUnitId   String    @map("working_unit_id")
  userId          String    @map("user_id")
  positionId      String?   @map("position_id") // Links to Position (cargo)
  role            String    // COORDINATOR | LEADER | MEMBER | GUEST
  isLeader        Boolean   @default(false) @map("is_leader")
  canApprove      Boolean   @default(false) @map("can_approve")
  joinedAt        DateTime  @default(now()) @map("joined_at")
  leftAt          DateTime? @map("left_at")
  status          String    @default("ACTIVE") // ACTIVE | INACTIVE | REMOVED
  metadata        Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workingUnit     WorkingUnit @relation(fields: [workingUnitId], references: [id], onDelete: Cascade)

  @@unique([tenantId, workingUnitId, userId])
  @@index([tenantId])
  @@index([tenantId, workingUnitId])
  @@index([tenantId, userId])
  @@index([tenantId, positionId])
  @@index([tenantId, status])
  @@map("working_unit_memberships")
}

// ============================================
// FORM STUDIO DOMAIN
// ============================================

/// DataEntryForm - Form definitions for data collection
model DataEntryForm {
  id                String    @id @default(uuid())
  tenantId          String    @map("tenant_id")
  formId            String    @unique @map("form_id") // Public form identifier
  name              String
  description       String?
  entityType        String?   @map("entity_type") // EVENT | MEMBER | STRUCTURE | CUSTOM
  entityId          String?   @map("entity_id") // Links to specific entity if not a template
  version           String    @default("1.0.0")
  status            String    @default("DRAFT") // DRAFT | TESTING | PUBLISHED | DEPRECATED
  layout            Json?     // Grid layout configuration
  fields            Json      // Array of field definitions
  validationRules   Json?     @map("validation_rules") // Global validation rules
  metadata          Json?
  publishedAt       DateTime? @map("published_at")
  publishedBy       String?   @map("published_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  versions    FormVersion[]
  submissions FormSubmission[]

  @@unique([tenantId, formId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, entityType])
  @@index([tenantId, entityType, entityId])
  @@map("data_entry_forms")
}

/// FormVersion - Frozen snapshots of form schemas
model FormVersion {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  formId      String   @map("form_id")
  version     String
  schema      Json     // Frozen snapshot of fields + layout
  changelog   String?
  publishedAt DateTime @default(now()) @map("published_at")
  publishedBy String   @map("published_by")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  form DataEntryForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@unique([formId, version])
  @@index([tenantId])
  @@index([tenantId, formId])
  @@map("form_versions")
}

/// FormSubmission - Submitted form data
model FormSubmission {
  id               String    @id @default(uuid())
  tenantId         String    @map("tenant_id")
  formId           String    @map("form_id")
  formVersion      String    @map("form_version")
  entityType       String?   @map("entity_type") // EVENT | MEMBER | STRUCTURE
  entityId         String?   @map("entity_id") // Links to specific entity
  data             Json      // Submitted form data
  status           String    @default("pending") // pending | validated | processed | error
  validationErrors Json?     @map("validation_errors")
  processedAt      DateTime? @map("processed_at")
  submittedBy      String?   @map("submitted_by")
  submittedAt      DateTime  @default(now()) @map("submitted_at")
  metadata         Json?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  form DataEntryForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, formId])
  @@index([tenantId, formId, status])
  @@index([tenantId, entityType, entityId])
  @@index([submittedAt])
  @@map("form_submissions")
}

/// FormDataSource - Data source containers for form entries
model FormDataSource {
  id               String    @id @default(uuid())
  tenantId         String    @map("tenant_id")
  name             String
  description      String?
  formDefinitionId String?   @unique @map("form_definition_id") // Links to DataEntryForm (one-to-one)
  lookupFieldId    String?   @map("lookup_field_id") // Field ID from form used for lookup/search
  createdBy        String?   @map("created_by")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  entries FormDataSourceEntry[]

  @@index([tenantId])
  @@index([tenantId, formDefinitionId])
  @@map("form_data_sources")
}

/// FormDataSourceEntry - Individual entries in a data source
model FormDataSourceEntry {
  id               String    @id @default(uuid())
  tenantId         String    @map("tenant_id")
  dataSourceId     String    @map("data_source_id")
  formDefinitionId String    @map("form_definition_id")
  formVersion      String    @map("form_version")
  data             Json      // Submitted form data
  submittedBy      String?   @map("submitted_by")
  submittedByName  String?   @map("submitted_by_name")
  submittedAt      DateTime  @default(now()) @map("submitted_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  dataSource FormDataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, dataSourceId])
  @@index([tenantId, formDefinitionId])
  @@index([submittedAt])
  @@map("form_data_source_entries")
}

/// FormDataView - Saved query configurations for multi-source data views
model FormDataView {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  config      Json     // Stores query configuration (sources, joins, filters)
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("form_data_views")
}

// ============================================
// PLM DOMAIN - Pipeline Lifecycle Manager
// ============================================

/// Pipeline - represents a workflow pipeline definition
model PlmPipeline {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  projectId       String?   @map("project_id")
  projectName     String?   @map("project_name")
  key             String    // Unique key within tenant (e.g., "ONBOARDING")
  name            String
  description     String?
  lifecycleStatus String    @default("DRAFT") @map("lifecycle_status") // DRAFT, TEST, PUBLISHED, CLOSED, ARCHIVED
  publishedVersion Int?     @map("published_version")
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  versions    PlmPipelineVersion[]
  cards       PlmCard[]
  permissions PlmPipelinePermission[]
  cycles      Cycle[]

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([tenantId, lifecycleStatus])
  @@index([tenantId, projectId])
  @@map("plm_pipelines")
}

/// PlmPipelineVersion - versioned snapshots of pipeline configuration
model PlmPipelineVersion {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  pipelineId      String    @map("pipeline_id")
  versionNumber   Int       @map("version_number")
  versionStatus   String    @default("DRAFT") @map("version_status") // DRAFT, PUBLISHED
  publishedAt     DateTime? @map("published_at")
  publishedBy     String?   @map("published_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  pipeline    PlmPipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stages      PlmStage[]
  transitions PlmStageTransition[]

  @@unique([pipelineId, versionNumber])
  @@index([tenantId])
  @@index([tenantId, pipelineId])
  @@index([tenantId, versionStatus])
  @@map("plm_pipeline_versions")
}

/// PlmStage - represents a stage/column in the pipeline
model PlmStage {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  pipelineVersionId String   @map("pipeline_version_id")
  name              String
  stageOrder        Int      @map("stage_order")
  classification    String   @default("NOT_STARTED") // NOT_STARTED, ON_GOING, WAITING, FINISHED, CANCELED
  color             String   @default("#6B7280")
  isInitial         Boolean  @default(false) @map("is_initial")
  isFinal           Boolean  @default(false) @map("is_final")
  approvalOutcome   String?  @map("approval_outcome") // APPROVE, REJECT, CANCEL - used by governance workflow
  wipLimit          Int?     @map("wip_limit") // Work-in-progress limit
  slaHours          Int?     @map("sla_hours")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  pipelineVersion   PlmPipelineVersion       @relation(fields: [pipelineVersionId], references: [id], onDelete: Cascade)
  formAttachRules   PlmStageFormAttachRule[]
  triggers          PlmStageTrigger[]
  fromTransitions   PlmStageTransition[]     @relation("FromStage")
  toTransitions     PlmStageTransition[]     @relation("ToStage")
  cards             PlmCard[]
  moveHistoryFrom   PlmCardMoveHistory[]     @relation("FromStageHistory")
  moveHistoryTo     PlmCardMoveHistory[]     @relation("ToStageHistory")
  avatarRules       PlmStageAvatarRule[]

  @@unique([pipelineVersionId, stageOrder])
  @@index([tenantId])
  @@index([tenantId, pipelineVersionId])
  @@index([classification])
  @@map("plm_stages")
}

/// PlmStageTransition - allowed transitions between stages
model PlmStageTransition {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  pipelineVersionId String   @map("pipeline_version_id")
  fromStageId       String   @map("from_stage_id")
  toStageId         String   @map("to_stage_id")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  pipelineVersion PlmPipelineVersion       @relation(fields: [pipelineVersionId], references: [id], onDelete: Cascade)
  fromStage       PlmStage                 @relation("FromStage", fields: [fromStageId], references: [id], onDelete: Cascade)
  toStage         PlmStage                 @relation("ToStage", fields: [toStageId], references: [id], onDelete: Cascade)
  rules           PlmStageTransitionRule[]

  @@unique([pipelineVersionId, fromStageId, toStageId])
  @@index([tenantId])
  @@index([fromStageId])
  @@index([toStageId])
  @@map("plm_stage_transitions")
}

/// PlmStageTransitionRule - rules that must be satisfied for a transition
model PlmStageTransitionRule {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  transitionId     String   @map("transition_id")
  ruleType         String   @map("rule_type") // FORM_REQUIRED, COMMENT_REQUIRED, OWNER_ONLY
  formDefinitionId String?  @map("form_definition_id") // For FORM_REQUIRED rule, links to DataEntryForm
  enabled          Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  transition PlmStageTransition @relation(fields: [transitionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([transitionId])
  @@map("plm_stage_transition_rules")
}

/// PlmStageFormAttachRule - rules for attaching forms to cards at stages
model PlmStageFormAttachRule {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  stageId           String   @map("stage_id")
  formDefinitionId  String?  @map("form_definition_id") // Links to DataEntryForm
  externalFormId    String?  @map("external_form_id") // For external forms
  externalFormName  String?  @map("external_form_name")
  defaultFormStatus String   @default("TO_FILL") @map("default_form_status") // FILLED, TO_FILL, LOCKED
  uniqueKeyFieldId  String?  @map("unique_key_field_id") // Field to use as unique key for dedup
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  stage PlmStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([stageId])
  @@index([formDefinitionId])
  @@map("plm_stage_form_attach_rules")
}

/// PlmCard - represents an item/card moving through the pipeline
model PlmCard {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  pipelineId      String    @map("pipeline_id")
  pipelineVersion Int       @map("pipeline_version")
  currentStageId  String    @map("current_stage_id")
  title           String
  description     String?
  priority        String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  status          String    @default("ACTIVE") // ACTIVE, CLOSED, ARCHIVED
  uniqueKeyValue  String?   @map("unique_key_value") // Unique identifier for dedup
  ownerId         String?   @map("owner_id") // User who owns the card
  metadata        Json?
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  closedAt        DateTime? @map("closed_at")

  // Relations
  pipeline     PlmPipeline          @relation(fields: [pipelineId], references: [id])
  currentStage PlmStage             @relation(fields: [currentStageId], references: [id])
  forms        PlmCardForm[]
  moveHistory  PlmCardMoveHistory[]
  comments     PlmCardComment[]
  triggerExecutions PlmTriggerExecution[]

  @@unique([tenantId, pipelineId, uniqueKeyValue])
  @@index([tenantId])
  @@index([tenantId, pipelineId])
  @@index([tenantId, pipelineId, currentStageId])
  @@index([tenantId, status])
  @@index([tenantId, priority])
  @@index([tenantId, ownerId])
  @@map("plm_cards")
}

/// PlmCardForm - form data attached to a card
model PlmCardForm {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  cardId            String   @map("card_id")
  formDefinitionId  String?  @map("form_definition_id") // Links to DataEntryForm
  externalFormId    String?  @map("external_form_id")
  formVersion       String?  @map("form_version")
  status            String   @default("TO_FILL") // FILLED, TO_FILL, LOCKED
  data              Json     @default("{}")
  attachedAtStageId String   @map("attached_at_stage_id")
  attachedAt        DateTime @default(now()) @map("attached_at")
  filledAt          DateTime? @map("filled_at")
  filledBy          String?  @map("filled_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  card PlmCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([cardId])
  @@index([formDefinitionId])
  @@index([status])
  @@map("plm_card_forms")
}

/// PlmCardMoveHistory - history of card movements between stages
model PlmCardMoveHistory {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  cardId      String   @map("card_id")
  fromStageId String   @map("from_stage_id")
  toStageId   String   @map("to_stage_id")
  reason      String   @default("MANUAL") // MANUAL, API, AUTOMATION
  movedBy     String?  @map("moved_by")
  comment     String?
  movedAt     DateTime @default(now()) @map("moved_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  card      PlmCard  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  fromStage PlmStage @relation("FromStageHistory", fields: [fromStageId], references: [id])
  toStage   PlmStage @relation("ToStageHistory", fields: [toStageId], references: [id])

  @@index([tenantId])
  @@index([cardId])
  @@index([movedAt])
  @@map("plm_card_move_history")
}

/// PlmCardComment - comments on cards
model PlmCardComment {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  cardId    String   @map("card_id")
  userId    String?  @map("user_id")
  userName  String   @map("user_name")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  card PlmCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([cardId])
  @@index([createdAt])
  @@map("plm_card_comments")
}

/// PlmStageTrigger - automation triggers for stage events
model PlmStageTrigger {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")
  stageId          String   @map("stage_id")
  integrationId    String?  @map("integration_id") // Links to external integration
  integrationName  String?  @map("integration_name")
  integrationKey   String?  @map("integration_key")
  eventType        String   @map("event_type") // CARD_MOVEMENT, FORM_FIELD_CHANGE
  fromStageId      String?  @map("from_stage_id") // Filter: only trigger when coming from this stage
  formDefinitionId String?  @map("form_definition_id") // For FORM_FIELD_CHANGE event
  fieldId          String?  @map("field_id") // Specific field to monitor
  executionOrder   Int      @default(0) @map("execution_order")
  enabled          Boolean  @default(true)
  httpMethod       String?  @map("http_method") // GET, POST, PUT, PATCH, DELETE
  endpoint         String?
  defaultPayload   Json?    @map("default_payload")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  stage      PlmStage                  @relation(fields: [stageId], references: [id], onDelete: Cascade)
  conditions PlmStageTriggerCondition[]
  executions PlmTriggerExecution[]

  @@index([tenantId])
  @@index([stageId])
  @@index([eventType])
  @@index([enabled])
  @@map("plm_stage_triggers")
}

/// PlmStageTriggerCondition - conditions for trigger execution
model PlmStageTriggerCondition {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  triggerId String   @map("trigger_id")
  fieldPath String   @map("field_path") // JSONPath or dot notation to field
  operator  String   // EQUALS, NOT_EQUALS, GREATER_THAN, LESS_THAN, CONTAINS, etc.
  value     String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  trigger PlmStageTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([triggerId])
  @@map("plm_stage_trigger_conditions")
}

/// PlmTriggerExecution - log of trigger executions
model PlmTriggerExecution {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  triggerId       String    @map("trigger_id")
  cardId          String    @map("card_id")
  status          String    @default("PENDING") // PENDING, SUCCESS, FAILURE
  eventType       String    @map("event_type")
  integrationName String?   @map("integration_name")
  integrationKey  String?   @map("integration_key")
  stageName       String?   @map("stage_name")
  requestPayload  Json?     @map("request_payload")
  responsePayload Json?     @map("response_payload")
  errorMessage    String?   @map("error_message")
  executedAt      DateTime  @default(now()) @map("executed_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  trigger PlmStageTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  card    PlmCard         @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([triggerId])
  @@index([cardId])
  @@index([status])
  @@index([executedAt])
  @@map("plm_trigger_executions")
}

/// PlmUserGroup - user groups for pipeline permissions
model PlmUserGroup {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  createdBy   String?  @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members     PlmGroupMember[]
  permissions PlmPipelinePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("plm_user_groups")
}

/// PlmGroupMember - members of user groups
model PlmGroupMember {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  groupId   String   @map("group_id")
  userId    String   @map("user_id")
  userName  String?  @map("user_name")
  userEmail String?  @map("user_email")
  addedBy   String?  @map("added_by")
  addedAt   DateTime @default(now()) @map("added_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  group PlmUserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([tenantId])
  @@index([groupId])
  @@index([userId])
  @@map("plm_group_members")
}

/// PlmPipelinePermission - role-based access to pipelines
model PlmPipelinePermission {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  pipelineId String   @map("pipeline_id")
  groupId    String   @map("group_id")
  role       String   // VIEWER, OPERATOR, SUPERVISOR, ADMIN
  createdBy  String?  @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  pipeline PlmPipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  group    PlmUserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([pipelineId, groupId])
  @@index([tenantId])
  @@index([pipelineId])
  @@index([groupId])
  @@map("plm_pipeline_permissions")
}

/// PlmStageAvatarRule - avatar requirements for stage actions and card progression
/// Each stage can have multiple avatars with approval rules for advancing cards
model PlmStageAvatarRule {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  stageId      String   @map("stage_id")
  avatarId     String   @map("avatar_id")
  approvalRule String   @default("ONE_MEMBER") @map("approval_rule") // ONE_MEMBER, HALF_MEMBERS, MAJORITY
  ruleOrder    Int      @default(0) @map("rule_order") // Order of avatar rules for the stage
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  stage  PlmStage          @relation(fields: [stageId], references: [id], onDelete: Cascade)
  avatar ParticipantAvatar @relation(fields: [avatarId], references: [id], onDelete: Cascade)

  @@unique([stageId, avatarId])
  @@index([tenantId])
  @@index([stageId])
  @@index([avatarId])
  @@map("plm_stage_avatar_rules")
}

// ============================================
// GOVERNANCE DOMAIN - Approval Engine
// ============================================

/// GovApprovalPolicy - Defines when an action on an entity requires approval
/// Maps entityType + action to a PLM pipeline for workflow execution
model GovApprovalPolicy {
  id              String   @id @default(uuid())
  tenantId        String?  @map("tenant_id")
  code            String   @unique
  name            String
  description     String?
  entityType      String   @map("entity_type") // MEMBER, EVENT, STRUCTURE, RESERVATION, etc.
  action          String   // CREATE, UPDATE, DELETE, INACTIVATE, ACTIVATE
  operationScope  Json     @default("{}") @map("operation_scope") // { roles: [], segments: [], communities: [], custom: {} }
  conditions      Json     @default("{}") // { all: [], any: [] } - JSONLogic-like rules
  pipelineId      String   @map("pipeline_id") // Links to PlmPipeline
  pipelineVersion Int      @default(1) @map("pipeline_version")
  blocking        Boolean  @default(true) // If true, entity stays PENDING until approved
  enabled         Boolean  @default(true)
  priority        Int      @default(100) // Lower = higher priority (first match wins)
  createdBy       String?  @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  requests GovApprovalRequest[]

  @@index([tenantId])
  @@index([entityType, action, enabled, priority])
  @@index([pipelineId])
  @@map("gov_approval_policies")
}

/// GovApprovalRequest - Tracks an approval request linked to a PLM card
model GovApprovalRequest {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  requestKey      String    @unique @map("request_key") // Unique key for idempotency
  policyId        String?   @map("policy_id")
  pipelineId      String    @map("pipeline_id")
  pipelineVersion Int       @map("pipeline_version")
  cardId          String?   @map("card_id") // Links to PlmCard
  entityType      String    @map("entity_type")
  entityId        String    @map("entity_id")
  action          String    // CREATE, UPDATE, DELETE, INACTIVATE, ACTIVATE
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, APPROVED, REJECTED, CANCELED, EXPIRED
  blocking        Boolean   @default(true)
  requestedBy     String?   @map("requested_by")
  requestedAt     DateTime  @default(now()) @map("requested_at")
  currentStageKey String?   @map("current_stage_key")
  dueAt           DateTime? @map("due_at")
  decision        String?   // APPROVED, REJECTED
  decidedBy       String?   @map("decided_by")
  decidedAt       DateTime? @map("decided_at")
  decisionReason  String?   @map("decision_reason")
  context         Json      @default("{}") // Request context/metadata
  snapshot        Json      @default("{}") // Entity state snapshot at request time
  correlationId    String?   @map("correlation_id")
  idempotencyKey   String?   @map("idempotency_key")
  resolvedAt       DateTime? @map("resolved_at") // When the request was approved/rejected
  actionExecuted   Boolean   @default(false) @map("action_executed") // Whether the action was executed by the worker
  actionExecutedAt DateTime? @map("action_executed_at") // When the action was executed
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  policy    GovApprovalPolicy?    @relation(fields: [policyId], references: [id])
  evidences GovApprovalEvidence[]
  history   GovApprovalHistory[]

  @@index([tenantId])
  @@index([entityType, entityId, status])
  @@index([pipelineId, currentStageKey, status])
  @@index([status])
  @@index([cardId])
  @@map("gov_approval_requests")
}

/// GovApprovalEvidence - Evidence/attachments for approval requests
model GovApprovalEvidence {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  requestId     String   @map("request_id")
  type          String   // DOCUMENT, COMMENT, SCREENSHOT, SIGNATURE, OTHER
  title         String?
  content       String?
  attachmentUrl String?  @map("attachment_url")
  createdBy     String?  @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  metadata      Json     @default("{}")

  // Relations
  request GovApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([requestId])
  @@map("gov_approval_evidences")
}

/// GovApprovalHistory - History of status changes for approval requests
model GovApprovalHistory {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  requestId    String   @map("request_id")
  fromStatus   String?  @map("from_status")
  toStatus     String   @map("to_status")
  fromStageKey String?  @map("from_stage_key")
  toStageKey   String?  @map("to_stage_key")
  changedBy    String?  @map("changed_by")
  changedAt    DateTime @default(now()) @map("changed_at")
  comment      String?
  metadata     Json     @default("{}")

  // Relations
  request GovApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([requestId, changedAt])
  @@map("gov_approval_history")
}

// ============================================
// SYSTEM DOMAIN - Resource Registry
// ============================================

/// SystemResource - External API resources (LLMs, REST APIs, etc.)
model SystemResource {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  name            String
  type            String    // API_HTTP_OUTBOUND | API_HTTP_INBOUND | DATABASE | MESSAGE_QUEUE | STORAGE
  subtype         String    // LLM | REST | GRAPHQL | WEBHOOK | POSTGRES | MYSQL | MONGODB | REDIS | S3 | OTHER
  endpoint        String
  httpMethod      String    @map("http_method") // GET | POST | PUT | PATCH | DELETE
  authMode        String    @default("NONE") @map("auth_mode") // NONE | API_KEY | BEARER_TOKEN | BASIC_AUTH | OAUTH2
  apiKeyConfig    Json?     @map("api_key_config") // { apiKey, headerName, location }
  bearerConfig    Json?     @map("bearer_config") // { token }
  basicAuthConfig Json?     @map("basic_auth_config") // { username, password }
  oauth2Config    Json?     @map("oauth2_config") // { clientId, clientSecret, tokenUrl, scope }
  llmConfig       Json?     @map("llm_config") // { provider, model, description }
  connection      Json?     // Generic connection config
  configuration   Json?     // Generic configuration
  metadata        Json?
  tags            String[]  @default([])
  environment     String    @default("DEV") // DEV | STAGING | PROD
  status          String    @default("UNKNOWN") // AVAILABLE | UNAVAILABLE | DEGRADED | UNKNOWN
  lastTestedAt    DateTime? @map("last_tested_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, subtype])
  @@index([tenantId, environment])
  @@index([tenantId, status])
  @@map("system_resources")
}
