generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// APPROVALS
// ============================================

model Approval {
  id              String    @id @default(uuid())
  type            String
  state           String    @default("PENDING")
  candidateId     String    @map("candidate_id")
  candidateName   String?   @map("candidate_name")
  priority        String    @default("MEDIUM")
  tenantId        String    @map("tenant_id")
  orgId           String    @map("org_id")
  cycleId         String?   @map("cycle_id")
  metadata        Json?
  decidedAt       DateTime? @map("decided_at")
  decidedBy       String?   @map("decided_by")
  decisionReason  String?   @map("decision_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  @@index([tenantId, orgId])
  @@index([tenantId, state])
  @@index([tenantId, candidateId])
  @@index([tenantId, cycleId])
  @@index([createdAt])
  @@map("approvals")
}

// ============================================
// CANDIDATES (for Points calculation)
// ============================================

model Candidate {
  id          String   @id @default(uuid())
  name        String
  email       String?
  tenantId    String   @map("tenant_id")
  orgId       String   @map("org_id")
  score       Float    @default(0)
  rank        Int?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, email])
  @@index([tenantId, orgId])
  @@index([tenantId, score])
  @@map("candidates")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id            String   @id @default(uuid())
  action        String
  resourceType  String   @map("resource_type")
  resourceId    String   @map("resource_id")
  actorId       String   @map("actor_id")
  tenantId      String   @map("tenant_id")
  orgId         String   @map("org_id")
  correlationId String?  @map("correlation_id")
  metadata      Json?
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([tenantId, resourceType, resourceId])
  @@index([tenantId, actorId])
  @@index([tenantId, timestamp])
  @@index([correlationId])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String   @id @default(uuid())
  recipientId String   @map("recipient_id")
  channel     String   @default("PUSH")
  templateId  String?  @map("template_id")
  subject     String?
  message     String
  status      String   @default("PENDING")
  tenantId    String   @map("tenant_id")
  orgId       String   @map("org_id")
  metadata    Json?
  sentAt      DateTime? @map("sent_at")
  failedAt    DateTime? @map("failed_at")
  errorMessage String?  @map("error_message")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId, recipientId])
  @@index([tenantId, status])
  @@map("notifications")
}

// ============================================
// NOTIFICATION TEMPLATES
// ============================================

model NotificationTemplate {
  id        String   @id @default(uuid())
  name      String
  channel   String
  subject   String?
  body      String
  variables String[]
  tenantId  String   @map("tenant_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@map("notification_templates")
}

// ============================================
// POINTS DOMAIN - Ledger/Account System
// ============================================

/// Conta de pontos por tenant + owner (USER ou ORG)
model PointAccount {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  ownerType String   @map("owner_type") // USER | ORG
  ownerId   String   @map("owner_id")
  status    String   @default("ACTIVE") // ACTIVE | SUSPENDED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ledgerEntries PointLedgerEntry[]
  holds         PointHold[]

  @@unique([tenantId, ownerType, ownerId])
  @@index([tenantId])
  @@index([ownerId])
  @@map("point_accounts")
}

/// Ledger append-only. Cada linha representa um movimento de pontos.
model PointLedgerEntry {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  accountId      String   @map("account_id")
  entryType      String   @map("entry_type") // CREDIT | DEBIT | HOLD | RELEASE | COMMIT | REVERSAL
  amount         Int      // sempre > 0
  reasonCode     String   @map("reason_code")
  referenceType  String   @map("reference_type") // RESERVATION | PURCHASE | APPROVAL | ADJUSTMENT | REFUND | SYSTEM
  referenceId    String   @map("reference_id")
  idempotencyKey String?  @map("idempotency_key")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  account PointAccount @relation(fields: [accountId], references: [id])

  @@index([tenantId, accountId, createdAt])
  @@index([tenantId, referenceType, referenceId])
  @@index([idempotencyKey])
  @@map("point_ledger_entries")
}

/// Estado de holds (reservas) de pontos por referência
model PointHold {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  accountId     String    @map("account_id")
  referenceType String    @map("reference_type")
  referenceId   String    @map("reference_id")
  amount        Int
  status        String    @default("ACTIVE") // ACTIVE | COMMITTED | RELEASED | EXPIRED
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  account PointAccount @relation(fields: [accountId], references: [id])

  @@unique([tenantId, accountId, referenceType, referenceId])
  @@index([tenantId])
  @@index([accountId])
  @@index([status])
  @@map("point_holds")
}

// ============================================
// IDEMPOTENCY (Cross-domain)
// ============================================

/// Tabela reutilizável para idempotência de comandos
model IdempotencyRecord {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  scope           String    // ex: POINTS:HoldPoints, POINTS:CreditPoints
  idemKey         String    @map("idem_key") // Idempotency-Key recebido
  requestHash     String    @map("request_hash") // hash do payload
  status          String    @default("IN_PROGRESS") // IN_PROGRESS | COMPLETED | FAILED
  httpStatus      Int?      @map("http_status")
  responsePayload Json?     @map("response_payload")
  errorPayload    Json?     @map("error_payload")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  expiresAt       DateTime  @map("expires_at")

  @@unique([tenantId, scope, idemKey])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("idempotency_records")
}

// ============================================
// OUTBOX (Cross-domain event publishing)
// ============================================

/// Outbox pattern para publicação de eventos após commit
model OutboxEvent {
  id            String    @id @default(uuid())
  tenantId      String?   @map("tenant_id")
  aggregateType String    @map("aggregate_type") // POINTS | APPROVALS | etc
  aggregateId   String    @map("aggregate_id")
  eventType     String    @map("event_type") // PointsHeld | PointsCredited | etc
  correlationId String?   @map("correlation_id")
  payload       Json
  metadata      Json?
  status        String    @default("PENDING") // PENDING | PROCESSING | PUBLISHED | DEAD
  retryCount    Int       @default(0) @map("retry_count")
  maxRetries    Int       @default(3) @map("max_retries")
  lastError     String?   @map("last_error")
  processedAt   DateTime? @map("processed_at")
  scheduledAt   DateTime  @default(now()) @map("scheduled_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([status, scheduledAt])
  @@index([tenantId, aggregateType, aggregateId])
  @@map("outbox_events")
}

// ============================================
// RESERVATIONS DOMAIN
// ============================================

/// Reservation policy: rules for reservations by resource type
model ReservationPolicy {
  id               String    @id @default(uuid())
  tenantId         String    @map("tenant_id")
  eventId          String    @map("event_id")
  resourceType     String    @map("resource_type") // TABLE | SEAT | SLOT
  costInPoints     Int       @default(0) @map("cost_in_points")
  maxPerUser       Int       @default(1) @map("max_per_user")
  requiresApproval Boolean   @default(false) @map("requires_approval")
  holdTtlSeconds   Int       @default(900) @map("hold_ttl_seconds")
  windowStart      DateTime? @map("window_start")
  windowEnd        DateTime? @map("window_end")
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  reservations Reservation[]

  @@index([tenantId, eventId, resourceType, isActive])
  @@index([eventId])
  @@map("reservation_policies")
}

/// Reservable resource (table, seat, slot) with capacity
model ReservableResource {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  eventId       String   @map("event_id")
  resourceType  String   @map("resource_type") // TABLE | SEAT | SLOT
  name          String
  capacityTotal Int      @default(1) @map("capacity_total")
  metadata      Json?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  reservations Reservation[]

  @@index([tenantId, eventId, resourceType])
  @@index([tenantId, eventId, isActive])
  @@map("reservable_resources")
}

/// Reservation aggregate root - lifecycle HOLD -> CONFIRMED or HOLD -> RELEASED/EXPIRED
model Reservation {
  id           String    @id @default(uuid())
  tenantId     String    @map("tenant_id")
  eventId      String    @map("event_id")
  resourceId   String    @map("resource_id")
  resourceType String    @map("resource_type") // TABLE | SEAT | SLOT
  policyId     String    @map("policy_id")
  ownerId      String    @map("owner_id")
  ownerType    String    @map("owner_type") // MEMBER | LEADER | GUEST
  status       String    @default("HOLD") // HOLD | CONFIRMED | RELEASED | EXPIRED | CANCELLED
  pointsHoldId String?   @map("points_hold_id")
  expiresAt    DateTime? @map("expires_at")
  confirmedAt  DateTime? @map("confirmed_at")
  releasedAt   DateTime? @map("released_at")
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  resource ReservableResource @relation(fields: [resourceId], references: [id])
  policy   ReservationPolicy  @relation(fields: [policyId], references: [id])

  @@index([tenantId, eventId, ownerId, status])
  @@index([tenantId, resourceId, status])
  @@index([tenantId, eventId, resourceId, status])
  @@index([status, expiresAt])
  @@map("reservations")
}

// ============================================
// IDENTITY & ACCESS DOMAIN
// ============================================

/// Identity user - represents a user in the platform
model IdentityUser {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  externalId String?   @map("external_id")
  email      String?
  fullName   String?   @map("full_name")
  status     String    @default("ACTIVE") // ACTIVE | INACTIVE | SUSPENDED
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  assignments AccessAssignment[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, externalId])
  @@index([tenantId, status])
  @@map("identity_users")
}

/// Permission - atomic permissions (e.g., EVENTS.CREATE, POINTS.CREDIT)
model Permission {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, category])
  @@map("permissions")
}

/// Role - functional roles that group permissions
model Role {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  effect      String   @default("ALLOW") // ALLOW | DENY
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]
  assignments     AccessAssignment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("roles")
}

/// RolePermission - association between Role and Permission with effect
model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")
  effect       String @default("ALLOW") // ALLOW | DENY

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

/// AccessAssignment - assigns a Role to a User with scope
model AccessAssignment {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  roleId     String    @map("role_id")
  scopeType  String    @map("scope_type") // GLOBAL | TENANT | EVENT | COMMUNITY | TABLE | NETWORK_NODE | RESOURCE
  scopeId    String?   @map("scope_id")
  status     String    @default("ACTIVE") // ACTIVE | REVOKED
  assignedBy String?   @map("assigned_by")
  assignedAt DateTime  @default(now()) @map("assigned_at")
  revokedAt  DateTime? @map("revoked_at")
  metadata   Json?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  user IdentityUser @relation(fields: [userId], references: [id])
  role Role         @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId, roleId, scopeType, scopeId, status])
  @@index([tenantId, userId, status])
  @@index([tenantId, roleId, status])
  @@index([tenantId, scopeType, scopeId])
  @@map("access_assignments")
}

// ============================================
// EVENTS DOMAIN
// ============================================

/// Event - represents an event with lifecycle management
model Event {
  id              String    @id @default(uuid())
  tenantId        String    @map("tenant_id")
  name            String
  description     String?
  status          String    @default("DRAFT") // DRAFT | PUBLISHED | ACTIVE | CLOSED | CANCELED
  visibility      String    @default("PUBLIC") // PUBLIC | PRIVATE | INVITE_ONLY
  reservationMode String    @default("FREE") @map("reservation_mode") // POINTS | FREE | APPROVAL
  startsAt        DateTime  @map("starts_at")
  endsAt          DateTime  @map("ends_at")
  metadata        Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  phases         EventPhase[]
  tables         EventTable[]
  policyBindings EventPolicyBinding[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, visibility, status])
  @@index([tenantId, startsAt, endsAt])
  @@map("events")
}

/// EventPhase - represents a logical phase of an event
model EventPhase {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  eventId   String   @map("event_id")
  name      String
  startsAt  DateTime @map("starts_at")
  endsAt    DateTime @map("ends_at")
  sortOrder Int      @default(0) @map("sort_order")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([tenantId, eventId])
  @@map("event_phases")
}

/// EventTable - represents a table within an event
model EventTable {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  eventId   String   @map("event_id")
  name      String
  capacity  Int      @default(1)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  seats EventSeat[]

  @@index([tenantId, eventId])
  @@map("event_tables")
}

/// EventSeat - represents a seat inside a table
model EventSeat {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  eventId    String   @map("event_id")
  tableId    String   @map("table_id")
  seatNumber Int      @map("seat_number")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  table EventTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, seatNumber])
  @@index([tenantId, eventId])
  @@index([tenantId, tableId])
  @@map("event_seats")
}

/// EventPolicyBinding - associates governance or reservation policies to the event
model EventPolicyBinding {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  eventId    String   @map("event_id")
  policyCode String   @map("policy_code")
  scope      String   @default("EVENT") // GLOBAL | TENANT | EVENT
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([tenantId, eventId, policyCode])
  @@index([tenantId, eventId])
  @@map("event_policy_bindings")
}

// ============================================
// GOVERNANCE DOMAIN
// ============================================

/// GovernancePolicy - represents a governance policy with rules and scope
model GovernancePolicy {
  id          String   @id @default(uuid())
  tenantId    String?  @map("tenant_id")
  code        String   @unique
  name        String
  description String?
  status      String   @default("ACTIVE") // ACTIVE | DEPRECATED
  scope       String   @default("GLOBAL") // GLOBAL | TENANT
  rules       Json     // PolicyRules: { conditions: [], effect: 'ALLOW' | 'DENY' }
  version     Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@index([scope])
  @@map("governance_policies")
}

/// GovernanceAuditLog - immutable audit record of governance evaluations
model GovernanceAuditLog {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  policyCode  String   @map("policy_code")
  policyId    String?  @map("policy_id")
  decision    String   // ALLOW | DENY
  context     Json     // PolicyEvaluationContext
  reason      String?
  evaluatedAt DateTime @default(now()) @map("evaluated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([tenantId, policyCode])
  @@index([tenantId, decision])
  @@index([evaluatedAt])
  @@map("governance_audit_logs")
}

// ============================================
// AUDIT & COMPLIANCE DOMAIN
// ============================================

/// ComplianceCheck - rule definition for compliance validation
model ComplianceCheck {
  id          String   @id @default(uuid())
  tenantId    String?  @map("tenant_id")
  code        String   @unique
  name        String
  description String?
  severity    String   @default("MEDIUM") // LOW | MEDIUM | HIGH | CRITICAL
  rules       Json     // ComplianceRules: { type: 'RULE_SET', rules: [] }
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  results ComplianceCheckResult[]

  @@index([tenantId])
  @@index([enabled])
  @@index([severity])
  @@map("compliance_checks")
}

/// ComplianceCheckResult - result of a single compliance check execution
model ComplianceCheckResult {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  checkId    String   @map("check_id")
  checkCode  String   @map("check_code")
  reportId   String?  @map("report_id")
  status     String   // PASS | FAIL | WARNING
  evidence   Json?    // array of evidence items
  executedAt DateTime @default(now()) @map("executed_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  check  ComplianceCheck   @relation(fields: [checkId], references: [id])
  report ComplianceReport? @relation(fields: [reportId], references: [id])

  @@index([tenantId])
  @@index([tenantId, checkCode])
  @@index([tenantId, reportId])
  @@index([tenantId, status])
  @@index([executedAt])
  @@map("compliance_check_results")
}

/// ComplianceReport - snapshot of compliance execution results
model ComplianceReport {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  summary     Json     // ComplianceSummary: { totalChecks, passed, failed, warnings }
  generatedAt DateTime @default(now()) @map("generated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  results ComplianceCheckResult[]

  @@index([tenantId])
  @@index([generatedAt])
  @@map("compliance_reports")
}
